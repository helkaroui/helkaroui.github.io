<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Sharek.dev Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Sharek.dev Blog Atom Feed"><title data-react-helmet="true">02- Secure Nginx | Sharek.dev</title><meta data-react-helmet="true" property="og:url" content="https://helkaroui.github.io/home_lab/infrastructure/nginx/nginx-security-best-practices"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-home_lab_notes-current"><meta data-react-helmet="true" property="og:title" content="02- Secure Nginx | Sharek.dev"><meta data-react-helmet="true" name="description" content="Nginx is a lightweight, high-performance web server/reverse proxy and e-mail (IMAP/POP3) proxy. According to Netcraft,"><meta data-react-helmet="true" property="og:description" content="Nginx is a lightweight, high-performance web server/reverse proxy and e-mail (IMAP/POP3) proxy. According to Netcraft,"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://helkaroui.github.io/home_lab/infrastructure/nginx/nginx-security-best-practices"><link data-react-helmet="true" rel="alternate" href="https://helkaroui.github.io/home_lab/infrastructure/nginx/nginx-security-best-practices" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://helkaroui.github.io/home_lab/infrastructure/nginx/nginx-security-best-practices" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f2b4600b.css">
<link rel="preload" href="/assets/js/runtime~main.b0800c68.js" as="script">
<link rel="preload" href="/assets/js/main.7c46bf69.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Sharek.dev</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/home_lab/overview/">my Home Lab</a><a class="navbar__item navbar__link" href="/big_data/overview/">Big Data Tutorials</a><a class="navbar__item navbar__link" href="/cloud/kubernetes/getting_started">Cloud</a><a class="navbar__item navbar__link" href="/scala/quick_start/">Scala</a><a class="navbar__item navbar__link" href="/python/quick_start/">Python</a><a class="navbar__item navbar__link" href="/go/quick_start/">Go</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Sharek.dev</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/home_lab/overview/">my Home Lab</a></li><li class="menu__list-item"><a class="menu__link" href="/big_data/overview/">Big Data Tutorials</a></li><li class="menu__list-item"><a class="menu__link" href="/cloud/kubernetes/getting_started">Cloud</a></li><li class="menu__list-item"><a class="menu__link" href="/scala/quick_start/">Scala</a></li><li class="menu__list-item"><a class="menu__link" href="/python/quick_start/">Python</a></li><li class="menu__list-item"><a class="menu__link" href="/go/quick_start/">Go</a></li><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/home_lab/overview">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/home_lab/design">Design &amp; Decisions</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Infrastructure</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Network &amp; Security</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/home_lab/infrastructure/powerdns">PowerDNS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/home_lab/infrastructure/openvpn">OpenVPN</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/home_lab/infrastructure/keycloak">Keycloak</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Nginx</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/home_lab/infrastructure/nginx/setup">01- setup Nginx</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/home_lab/infrastructure/nginx/nginx-security-best-practices">02- Secure Nginx</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Storage</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/home_lab/infrastructure/minio">Minio</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/home_lab/infrastructure/mount_disk">Mount disk</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Applications</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/home_lab/infrastructure/compare_used_cars">Used Cars Comparator</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/home_lab/tutorials/docker_cheatsheet">Docker cheatsheet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/home_lab/tutorials/k8s_cheatsheet">K8s cheatsheet</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">02- Secure Nginx</h1></header><div class="markdown"><p>Nginx is a lightweight, high-performance web server/reverse proxy and e-mail (IMAP/POP3) proxy. According to Netcraft,
13.50% of all domains on the Internet use nginx web server. Nginx is one of a handful of servers written to address the
C10K problem. Unlike traditional servers, Nginx doesn’t rely on threads to handle requests. Instead, it uses a much more
scalable event-driven (asynchronous) architecture. Nginx powers several high traffic web sites, such as WordPress, Hulu,
Github, and SourceForge.</p><p>This page collects hints how to improve the security of nginx web servers running on Linux operating system.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-use-restrictive-iptables-based-firewall"></a>#1 Use restrictive Iptables Based Firewall<a class="hash-link" href="#1-use-restrictive-iptables-based-firewall" title="Direct link to heading">#</a></h2><p>The following firewall script blocks everything and only allows:</p><ul><li>Incoming HTTP (TCP port 80) requests</li><li>Incoming HTTPS (TCP port 443) requests</li><li>Incoming ICMP ping requests</li></ul><p>In this tutorial we will use UFW to manage Iptables:</p><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>UFW is a simplified command line configuration tool from Netfilter, which provides an alternative to the iptables
tool. UFW should eventually allow automatic configuration of the firewall when installing programs that need it.</p><p>check if UFW is enabled on your system :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw status</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If UFW is down you can enable it by running this command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">enable</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></div><p>To see the firewall current status, we will run the following command with verbose enabled :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw status verbose</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">Status: active</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Logging: on (low)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Default: deny (incoming), allow (outgoing), deny (routed)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">New profiles: skip</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">To                         Action      From</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">--                         ------      ----</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">80                         ALLOW IN    192.168.0.0/24</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Here we have only one rule; and it&#x27;s instructing our firewall to only accept incoming connection on port 53.</p><p>So, now want to allow incoming connections on the following ports: <code>80, 443</code></p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Allowing important ports</div><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw allow </span><span class="token number">80</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw allow </span><span class="token number">443</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then we need to instruct the firewall to deny anything else :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw default deny</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Another recommended practice is to enable logging and send it to a monitoring tool like ELK or Promotheus</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Enable logging</div><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw logging on</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Logs will be written to <code>/var/log/ufw.log</code></p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>If you run out of disk space, think to install a log curator or just run the following commands :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw logging off</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw logging low</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="debugging"></a>Debugging:<a class="hash-link" href="#debugging" title="Direct link to heading">#</a></h4><p>You should be aware that if your application should make outgoing call, you need to allow outgoing DNS queries.
This is done by running this command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> ufw allow out </span><span class="token number">53</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-controlling-buffer-overflow-attacks"></a>#2: Controlling Buffer Overflow Attacks<a class="hash-link" href="#2-controlling-buffer-overflow-attacks" title="Direct link to heading">#</a></h2><p>Edit nginx.conf and set the buffer size limitations for all clients.</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"> ## Start: Size Limits &amp; Buffer Overflows ##</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  client_body_buffer_size  1K;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  client_header_buffer_size 1k;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  client_max_body_size 1k;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  large_client_header_buffers 2 1k;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"> ## END: Size Limits &amp; Buffer Overflows ##</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><br><p>Where,</p><ul><li><code>client_body_buffer_size 1k</code> – (default is 8k or 16k) The directive specifies the client request body buffer size.</li><li><code>client_header_buffer_size 1k</code> – Directive sets the headerbuffer size for the request header from client. For the overwhelming majority of requests a buffer size of 1K is sufficient. Increase this if you have a custom header or a large cookie sent from the client (e.g., wap client).</li><li><code>client_max_body_size 1k</code>– Directive assigns the maximum accepted body size of client request, indicated by the line Content-Length in the header of request. If size is greater the given one, then the client gets the error “Request Entity Too Large” (413). Increase this when you are getting file uploads via the POST method.</li><li><code>large_client_header_buffers 2 1k</code> – Directive assigns the maximum number and size of buffers for large headers to read from client request. By default the size of one buffer is equal to the size of page, depending on platform this either 4K or 8K, if at the end of working request connection converts to state keep-alive, then these buffers are freed. 2x1k will accept 2kB data URI. This will also help combat bad bots and DoS attacks.</li></ul><p>You also need to control timeouts to improve server performance and cut clients. Edit it as follows:</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">## Start: Timeouts ##</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  client_body_timeout   10;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  client_header_timeout 10;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  keepalive_timeout     5 5;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  send_timeout          10;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">## End: Timeouts ##</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><code>client_body_timeout 10;</code> – Directive sets the read timeout for the request body from client. The timeout is set only if a body is not get in one readstep. If after this time the client send nothing, nginx returns error “Request time out” (408). The default is 60.</li><li><code>client_header_timeout 10;</code> – Directive assigns timeout with reading of the title of the request of client. The timeout is set only if a header is not get in one readstep. If after this time the client send nothing, nginx returns error “Request time out” (408).</li><li><code>keepalive_timeout 5 5;</code> – The first parameter assigns the timeout for keep-alive connections with the client. The server will close connections after this time. The optional second parameter assigns the time value in the header Keep-Alive: timeout=time of the response. This header can convince some browsers to close the connection, so that the server does not have to. Without this parameter, nginx does not send a Keep-Alive header (though this is not what makes a connection “keep-alive”).</li><li><code>send_timeout 10;</code> – Directive assigns response timeout to client. Timeout is established not on entire transfer of answer, but only between two operations of reading, if after this time client will take nothing, then nginx is shutting down the connection.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-control-simultaneous-connections"></a>#3: Control Simultaneous Connections<a class="hash-link" href="#3-control-simultaneous-connections" title="Direct link to heading">#</a></h2><p>You can use NginxHttpLimitZone module to limit the number of simultaneous connections for the assigned session or as a
special case, from one IP address. Add the following lines:</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">### Directive describes the zone, in which the session states are stored i.e. store in slimits. ###</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">### 1m can handle 32000 sessions with 32 bytes/session, set to 5m x 32000 session ###</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       limit_zone slimits $binary_remote_addr 5m;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">### Control maximum number of simultaneous connections for one session i.e. ###</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">### restricts the amount of connections from a single ip address ###</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        limit_conn slimits 5;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The above will limits remote clients to no more than 5 concurrently “open” connections per remote ip address.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-allow-access-to-our-domain-only"></a>#4: Allow Access To Our Domain Only<a class="hash-link" href="#4-allow-access-to-our-domain-only" title="Direct link to heading">#</a></h2><p>If bot is just making random server scan for all domains, just deny it. You must only allow configured virtual domain or
reverse proxy requests. You don’t want to display request using an IP address. Add the following lines at the end of the
config file:</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">## Only requests to our sites are allowed</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">http </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    server </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        listen      </span><span class="token number">80</span><span class="token plain"> default_server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        server_name _</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">return</span><span class="token plain">      </span><span class="token number">444</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># &quot;Connection closed without response&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">##</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5-deny-certain-user-agents"></a>#5: Deny Certain User-Agents<a class="hash-link" href="#5-deny-certain-user-agents" title="Direct link to heading">#</a></h2><p>You can easily block user-agents i.e. scanners, bots, and spammers who may be abusing your server.</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">## Block download agents ##</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if ($http_user_agent ~* LWP::Simple|BBBike|wget) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            return 444;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">##</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>For testing:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> --head -A </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;wget&quot;</span><span class="token plain"> https://www.sharek.dev/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><strong>What is http status 444 ?</strong>
A non-standard status code used to instruct nginx to close the connection without sending a response to the client, most
commonly used to deny malicious or malformed requests.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="6-only-allow-ssl-requests"></a>#6: Only allow SSL requests<a class="hash-link" href="#6-only-allow-ssl-requests" title="Direct link to heading">#</a></h2><p>The first step in web security is to implement SSL so that you can access web applications with https and add a layer of
encryption in the communication.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">server {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  listen 80;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  server_name sharek.dev;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  return 301 https://$host$request_uri;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">server {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    listen  443 ssl;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    server_name               sharek.dev;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    ssl_certificate     /path/to/certs/cert.pem;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    ssl_certificate_key /path/to/certs/privkey.pem;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    index                     index.html index.htm index.php;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    root                      /var/www/html;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Having SSL does not mean it is fully secure and this is where as a web security expert you need to apply some
configuration to secure the web server.</p><p>To start with, we recommend running an SSL scan against the website to find the score and the critical vulnerability.
Here is a well known online tool <a href="https://www.ssllabs.com/ssltest/index.html" target="_blank" rel="noopener noreferrer">SSLLabs</a></p><img alt="Docusaurus with Keytar" src="/img/notes.home_cloud_notes.tutorials.01-ssllabs-report-01.png"><p>With our current setup, we&#x27;ve scored a B rating ! Nice, but if we want to push it further we need to apply some technics
found in this article: <a href="https://geekflare.com/fr/nginx-webserver-security-hardening-guide/" target="_blank" rel="noopener noreferrer">https://geekflare.com/fr/nginx-webserver-security-hardening-guide/</a></p><p>TBC</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="7-disable-server-banner"></a>#7: Disable server banner<a class="hash-link" href="#7-disable-server-banner" title="Direct link to heading">#</a></h2><p>In the default NGINX configuration, the server header banner is ON which exposes the version of Nginx you are using.
This is particularly considered as information leak, coz it helps the attacker to identify you server version and hence
target it&#x27;s known vulnerabilities.
You can disable server banner with the following line :</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">server_tokens off;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now, check the response headers of a simple get request :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -I http://sharek.dev</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If this configuration is not get you will see the following output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">HTTP/1.1 301 Moved Permanently</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#F8F8F2"><span class="token plain">Server: nginx/1.18.0 (Ubuntu)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Date: Wed, 07 Apr 2021 13:52:15 GMT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Content-Type: text/html</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Content-Length: 178</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Connection: keep-alive</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Location: https://sharek.dev/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="8-clickjacking-attack"></a>#8: Clickjacking attack<a class="hash-link" href="#8-clickjacking-attack" title="Direct link to heading">#</a></h2><p>You can inject X-FRAME-OPTIONS in the HTTP header to prevent a clickjacking attack.
::::info</p><p>is a malicious technique of tricking a user into clicking on something different from what the user perceives, thus
potentially revealing confidential information or allowing others to take control of their computer while clicking on
seemingly innocuous objects, including web pages</p><p>::::</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">add_header X-Frame-Options &quot;SAMEORIGIN&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The above header will instruct a browser to load resources ONLY from the same origin.
Now, check the response headers of a simple get request :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -I http://sharek.dev</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">HTTP/1.1 301 Moved Permanently</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Date: Wed, 07 Apr 2021 13:52:15 GMT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Content-Type: text/html</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Content-Length: 178</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Connection: keep-alive</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Location: https://sharek.dev/</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#F8F8F2"><span class="token plain">X-Frame-Options: SAMEORIGIN</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="9-x-xss-protection"></a>#9: X-XSS Protection<a class="hash-link" href="#9-x-xss-protection" title="Direct link to heading">#</a></h2><p>Inject an HTTP header with X-XSS protection to mitigate cross-site scripting attacks.</p><p>::::Info</p><p>Cross-site scripting (XSS) is a security exploit which allows an attacker to inject into a website malicious client-side
code. This code is executed by the victims and lets the attackers bypass access controls and impersonate users.</p><p>::::</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">add_header X-XSS-Protection &quot;1; mode=block&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="10-disable-older-ssl-protocols-in-the-nginx-configuration"></a>#10: Disable older SSL protocols in the Nginx configuration.<a class="hash-link" href="#10-disable-older-ssl-protocols-in-the-nginx-configuration" title="Direct link to heading">#</a></h2><p>By default, Nginx installs with several older SSL protocols exposed, which could lead to a BEAST (Browser Exploit
Against SSL/TLS) attack. Older protocols should therefore be disabled for a better security posture. This can be
accomplished by defining the Nginx protocols/ciphers in your web server setting to only accept the newer, more secure
protocols.</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">Edit /etc/nginx/nginx.conf</div><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">        ##</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        # SSL Settings</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        ##</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#F8F8F2"><span class="token plain">        ssl_protocols TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To disable the weak protocols, simply delete  TLSv1 and TLSv1.1 protocols and append TLSv1.2 &amp;  TLSv1.3 at the end.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/home_lab/infrastructure/nginx/setup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 01- setup Nginx</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/home_lab/infrastructure/minio"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Minio »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-use-restrictive-iptables-based-firewall" class="table-of-contents__link">#1 Use restrictive Iptables Based Firewall</a></li><li><a href="#2-controlling-buffer-overflow-attacks" class="table-of-contents__link">#2: Controlling Buffer Overflow Attacks</a></li><li><a href="#3-control-simultaneous-connections" class="table-of-contents__link">#3: Control Simultaneous Connections</a></li><li><a href="#4-allow-access-to-our-domain-only" class="table-of-contents__link">#4: Allow Access To Our Domain Only</a></li><li><a href="#5-deny-certain-user-agents" class="table-of-contents__link">#5: Deny Certain User-Agents</a></li><li><a href="#6-only-allow-ssl-requests" class="table-of-contents__link">#6: Only allow SSL requests</a></li><li><a href="#7-disable-server-banner" class="table-of-contents__link">#7: Disable server banner</a></li><li><a href="#8-clickjacking-attack" class="table-of-contents__link">#8: Clickjacking attack</a></li><li><a href="#9-x-xss-protection" class="table-of-contents__link">#9: X-XSS Protection</a></li><li><a href="#10-disable-older-ssl-protocols-in-the-nginx-configuration" class="table-of-contents__link">#10: Disable older SSL protocols in the Nginx configuration.</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Recent articles</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/big_data/overview">Getting started with Spark</a></li><li class="footer__item"><a class="footer__link-item" href="/big_data/spark/optimizations/overview">Spark optimization techniques you should know about</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Sharek.dev, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b0800c68.js"></script>
<script src="/assets/js/main.7c46bf69.js"></script>
</body>
</html>