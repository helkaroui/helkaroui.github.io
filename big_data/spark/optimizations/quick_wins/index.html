<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Sharek.dev Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Sharek.dev Blog Atom Feed"><title data-react-helmet="true">Quick wins | Sharek.dev</title><meta data-react-helmet="true" property="og:url" content="https://helkaroui.github.io/big_data/spark/optimizations/quick_wins"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-big_data_notes-current"><meta data-react-helmet="true" property="og:title" content="Quick wins | Sharek.dev"><meta data-react-helmet="true" name="description" content="Here are simple rules to follow to avoid crashing your spark job :"><meta data-react-helmet="true" property="og:description" content="Here are simple rules to follow to avoid crashing your spark job :"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://helkaroui.github.io/big_data/spark/optimizations/quick_wins"><link data-react-helmet="true" rel="alternate" href="https://helkaroui.github.io/big_data/spark/optimizations/quick_wins" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://helkaroui.github.io/big_data/spark/optimizations/quick_wins" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f2b4600b.css">
<link rel="preload" href="/assets/js/runtime~main.8cfca04f.js" as="script">
<link rel="preload" href="/assets/js/main.733ffb78.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Sharek.dev</strong></a><a class="navbar__item navbar__link" href="/home_lab/overview/">my Home Lab</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/big_data/overview/">Big Data Tutorials</a><a class="navbar__item navbar__link" href="/cloud/kubernetes/getting_started">Cloud</a><a class="navbar__item navbar__link" href="/scala/quick_start/">Scala</a><a class="navbar__item navbar__link" href="/python/quick_start/">Python</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Sharek.dev</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/home_lab/overview/">my Home Lab</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/big_data/overview/">Big Data Tutorials</a></li><li class="menu__list-item"><a class="menu__link" href="/cloud/kubernetes/getting_started">Cloud</a></li><li class="menu__list-item"><a class="menu__link" href="/scala/quick_start/">Scala</a></li><li class="menu__list-item"><a class="menu__link" href="/python/quick_start/">Python</a></li><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/big_data/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Apache Spark</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">How to ?</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/spark/how_to/setup_standalone_cluster">Host your own Spark cluster</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Spark internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/spark/internals/overview">Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Spark optimizations</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/big_data/spark/optimizations/quick_wins">Quick wins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/big_data/spark/optimizations/reducebykey_vs_groupbykey">ReduceByKey vs GroupByKey</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kafka</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/kafka/quick_start">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/kafka/cheat_sheet">Cheat Sheet</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Quick wins</h1></header><div class="markdown"><p>Here are simple rules to follow to avoid crashing your spark job :</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="avoid-collecting-to-your-driver"></a>Avoid collecting to your driver<a class="hash-link" href="#avoid-collecting-to-your-driver" title="Direct link to heading">#</a></h2><p>If your Dataset is so large that all of it&#x27;s elements won&#x27;t fit in memory on the drive machine, don&#x27;t collect dataset
to the driver. Collect will attempt to copy every single element in the RDD onto the single driver program, and then run
out of memory and crash.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">val values = ds.collect()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Instead, you can make sure the number of elements you return is capped by calling <code>take</code> or <code>takeSample</code>, or perhaps
filtering or sampling your Dataset.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">val values = ds.take(10)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Similarly, be cautious of these other actions as well unless you are sure your dataset size is small enough to fit in
memory:</p><ul><li><code>countByKey</code></li><li><code>countByValue</code></li><li><code>collectAsMap</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="avoid-collect_list"></a>Avoid collect_list<a class="hash-link" href="#avoid-collect_list" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="avoid-counting"></a>Avoid counting<a class="hash-link" href="#avoid-counting" title="Direct link to heading">#</a></h2><p>Don&#x27;t use count() when you don&#x27;t need to return the exact number of rows. You can use this :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">if (df.takeAsList(1).size() == 0) {...}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">or</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">if (df.queryExecution.toRdd.isEmpty()) {...}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">or</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">if (ds.rdd.isEmpty()) {...}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>With RDDs, you can use isEmpty() because if you see <a href="https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/rdd/RDD.scala" target="_blank" rel="noopener noreferrer">the code</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">  /**</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   * @note Due to complications in the internal implementation, this method will raise an</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   * exception if called on an RDD of `Nothing` or `Null`. This may be come up in practice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   * because, for example, the type of `parallelize(Seq())` is `RDD[Nothing]`.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   * (`parallelize(Seq())` should be avoided anyway in favor of `parallelize(Seq[T]())`.)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   * @return true if and only if the RDD contains no elements at all. Note that an RDD</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   *         may be empty even when it has at least 1 partition.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   */</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  def isEmpty(): Boolean = withScope {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    partitions.length == 0 || take(1).length == 0</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="use-broadcast-for-small-datasets"></a>use Broadcast for small datasets<a class="hash-link" href="#use-broadcast-for-small-datasets" title="Direct link to heading">#</a></h2><p>Spark can “broadcast” a small DataFrame by sending all the data in that small DataFrame to all nodes in the cluster.
After the small DataFrame is broadcasted, Spark can perform a join without shuffling any of the data in the large DataFrame.</p><p>Let’s create a DataFrame with information about people and another DataFrame with information about cities. In this
example, the peopleDF is huge and the citiesDF is tiny. In this case broadcasting the citiesDF will accelerate the join.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">val citiesDF = Seq(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  (&quot;medellin&quot;, &quot;colombia&quot;, 2.5),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  (&quot;bangalore&quot;, &quot;india&quot;, 12.3)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">).toDF(&quot;city&quot;, &quot;country&quot;, &quot;population&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">peopleDF.join(</span></div><div class="token-line docusaurus-highlight-code-line" style="color:#F8F8F2"><span class="token plain">  broadcast(citiesDF),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  peopleDF(&quot;city&quot;) &lt;=&gt; citiesDF(&quot;city&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">).show()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>By default, spark will broadcast automatically any dataset with size under 10 MB. You can modify this threshold with
<code>spark.sql.autoBroadcastJoinThreshold</code> property.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/big_data/spark/internals/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/big_data/spark/optimizations/reducebykey_vs_groupbykey"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ReduceByKey vs GroupByKey »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#avoid-collecting-to-your-driver" class="table-of-contents__link">Avoid collecting to your driver</a></li><li><a href="#avoid-collect_list" class="table-of-contents__link">Avoid collect_list</a></li><li><a href="#avoid-counting" class="table-of-contents__link">Avoid counting</a></li><li><a href="#use-broadcast-for-small-datasets" class="table-of-contents__link">use Broadcast for small datasets</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Recent articles</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/big_data/overview">Getting started with Spark</a></li><li class="footer__item"><a class="footer__link-item" href="/big_data/spark/optimizations/overview">Spark optimization techniques you should know about</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Sharek.dev, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8cfca04f.js"></script>
<script src="/assets/js/main.733ffb78.js"></script>
</body>
</html>