<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Sharek.dev Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Sharek.dev Blog Atom Feed"><title data-react-helmet="true">ReduceByKey vs GroupByKey | Sharek.dev</title><meta data-react-helmet="true" property="og:url" content="https://helkaroui.github.io/big_data/spark/optimizations/reducebykey_vs_groupbykey"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-big_data_notes-current"><meta data-react-helmet="true" property="og:title" content="ReduceByKey vs GroupByKey | Sharek.dev"><meta data-react-helmet="true" name="description" content="In this article we are demystifying two known Spark Operators: reduceByKey and groupByKey"><meta data-react-helmet="true" property="og:description" content="In this article we are demystifying two known Spark Operators: reduceByKey and groupByKey"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://helkaroui.github.io/big_data/spark/optimizations/reducebykey_vs_groupbykey"><link data-react-helmet="true" rel="alternate" href="https://helkaroui.github.io/big_data/spark/optimizations/reducebykey_vs_groupbykey" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://helkaroui.github.io/big_data/spark/optimizations/reducebykey_vs_groupbykey" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f2b4600b.css">
<link rel="preload" href="/assets/js/runtime~main.47c2065c.js" as="script">
<link rel="preload" href="/assets/js/main.733ffb78.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Sharek.dev</strong></a><a class="navbar__item navbar__link" href="/home_lab/overview/">my Home Lab</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/big_data/overview/">Big Data Tutorials</a><a class="navbar__item navbar__link" href="/cloud/kubernetes/getting_started">Cloud</a><a class="navbar__item navbar__link" href="/scala/quick_start/">Scala</a><a class="navbar__item navbar__link" href="/python/quick_start/">Python</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Sharek" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Sharek.dev</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/home_lab/overview/">my Home Lab</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/big_data/overview/">Big Data Tutorials</a></li><li class="menu__list-item"><a class="menu__link" href="/cloud/kubernetes/getting_started">Cloud</a></li><li class="menu__list-item"><a class="menu__link" href="/scala/quick_start/">Scala</a></li><li class="menu__list-item"><a class="menu__link" href="/python/quick_start/">Python</a></li><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/big_data/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Apache Spark</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">How to ?</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/spark/how_to/setup_standalone_cluster">Host your own Spark cluster</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Spark internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/spark/internals/overview">Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Spark optimizations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/big_data/spark/optimizations/quick_wins">Quick wins</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/big_data/spark/optimizations/reducebykey_vs_groupbykey">ReduceByKey vs GroupByKey</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kafka</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/kafka/quick_start">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/big_data/kafka/cheat_sheet">Cheat Sheet</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">ReduceByKey vs GroupByKey</h1></header><div class="markdown"><p>In this article we are demystifying two known Spark Operators: <code>reduceByKey</code> and <code>groupByKey</code></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="groupbykey"></a>groupByKey<a class="hash-link" href="#groupbykey" title="Direct link to heading">#</a></h2><p>Imagine a Dataset distributed in 3 partitions. The dataset consist of a transactional table with in each row the revenue
of a store located in different countries. We want to sum these revenues at country level.</p><div class="codeBlockContainer_K1bP"><div style="color:#F8F8F2;background-color:#282A36" class="codeBlockTitle_eoMF">GroupByKey example</div><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">case class Record(country: String, revenue: Double)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">import spark.implicits._</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">val ds = Seq(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;USA&quot;, 112),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;USA&quot;, 250),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;USA&quot;, 360),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;INIDA&quot;, 102),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;INDIA&quot;, 205),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">).toDS[Record]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ds</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  .groupbByKey(_.country)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  .mapGroups((country, revenues) =&gt; Record(country, revenues.map(_.revenue).sum))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>a <code>groupByKey</code> will start by moving data from original partitions and create a partition per country (aggregation key).
Then, it will apply the aggregation function (here a <code>sum</code> function).</p><div style="text-align:center"><img alt="spark reducebykey" src="/img/groupByKeyDiagram.svg"></div><p>As shown in the diagram, the data will be repartitioned and thus a shuffle will take place. In real life data is not
naturally balanced, so in case where a key is too frequent, it&#x27;s related data will be put in one partition.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reducebykey"></a>reduceByKey<a class="hash-link" href="#reducebykey" title="Direct link to heading">#</a></h2><p>A <code>reduceByKey</code> will operate in two steps: (1) In each partition it will apply the aggregation function locally
(2) all the key-value pairs are then shuffled around, send over wire, and finally being reduced to get the final result.</p><p>Here is the implementation of the same example using reduceByKey :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><div tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">case class Record(country: String, revenue: Double)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">import spark.implicits._</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">val ds = Seq(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;USA&quot;, 112),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;USA&quot;, 250),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;USA&quot;, 360),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;INIDA&quot;, 102),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Record(&quot;INDIA&quot;, 205),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">).toDS[Record]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ds</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  .rdd</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  .keyBey(_.country)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  .reduceByKey((r1, r2) =&gt; r1.copy(revenue = r1.revenue + r2.revenue ) )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Look at the diagram below to understand what happens with reduceByKey. Notice how pairs on the same machine with the
same key are combined (by using the lamdba function passed into reduceByKey) before the data is shuffled. And only the
partial sum results are sent over the wire to be reduced.</p><div style="text-align:center"><img alt="spark reducebykey" src="/img/reduceByKeyDiagram.svg"></div><p>This means we are more likely to have an OOM exception with a groupByKey than a reduceByKey.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-oom-exception-occurs-"></a>How OOM exception occurs ?<a class="hash-link" href="#how-oom-exception-occurs-" title="Direct link to heading">#</a></h3><p>Spark spills data to disk when there is more data shuffled onto a single executor machine than can fit in memory.
However, it flushes out the data to disk one key at a time - so if a single key has more key-value pairs than can fit
in memory, an out of memory exception occurs.</p></div></div><p>While both of these functions will produce the correct answer, the reduceByKey example works much better on a large
dataset. That&#x27;s because Spark knows it can combine output with a common key on each partition before shuffling the data.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="when-to-avoid-groupbykey-"></a>When to avoid <code>groupByKey</code> ?<a class="hash-link" href="#when-to-avoid-groupbykey-" title="Direct link to heading">#</a></h2><p>You can imagine that for a much larger dataset size, the difference in the amount of data you are shuffling becomes
more exaggerated and different between reduceByKey and groupByKey. Here are some rules when to avoid a <code>groupByKey</code> :</p><ul><li>When returning a type different from your input value type. You would like to favor a <code>combineByKey</code> in this case.</li><li>When merging the values for each key using an associative function. You would like to use a <code>foldByKey</code> operator.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="when-to-avoid-reducebykey-"></a>When to avoid <code>reduceByKey</code> ?<a class="hash-link" href="#when-to-avoid-reducebykey-" title="Direct link to heading">#</a></h2><p>This operator is only available with RDD API, thus switching from typed dataset to rdd and back, induces performance
reduction due to java serialization.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Choosing the right operator can be tricky the first time, but can help to optimize long-running jobs quickly.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/big_data/spark/optimizations/quick_wins"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Quick wins</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/big_data/kafka/quick_start"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Quick Start »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#groupbykey" class="table-of-contents__link">groupByKey</a></li><li><a href="#reducebykey" class="table-of-contents__link">reduceByKey</a></li><li><a href="#when-to-avoid-groupbykey-" class="table-of-contents__link">When to avoid <code>groupByKey</code> ?</a></li><li><a href="#when-to-avoid-reducebykey-" class="table-of-contents__link">When to avoid <code>reduceByKey</code> ?</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Recent articles</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/big_data/overview">Getting started with Spark</a></li><li class="footer__item"><a class="footer__link-item" href="/big_data/spark/optimizations/overview">Spark optimization techniques you should know about</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/helkaroui" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Sharek.dev, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.47c2065c.js"></script>
<script src="/assets/js/main.733ffb78.js"></script>
</body>
</html>